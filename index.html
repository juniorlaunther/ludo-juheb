<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ludo Ju&Heb — Play</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#391629">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <style>
    :root{--bg:#391629;--panel:#4a1c37;--muted:#c9c3ca;--text:#fff;--accent:#017b3e;--accent2:#ff0a54;--accent3:#613f75;--accent4:#e85d04;--accent5:#d00000;--accent6:#087e8b;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35);--pad:16px;--gap:12px}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:radial-gradient(120% 120% at 0% 0%,#4a1c37 0%,#391629 40%,#2b1025 100%);padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right)}
    header{position:sticky;top:0;z-index:6;padding:calc(env(safe-area-inset-top) + 10px) var(--pad) 10px;display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(57,22,41,.7);border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 180deg,var(--accent),var(--accent2),var(--accent3),var(--accent4),var(--accent5),var(--accent6),var(--accent));box-shadow:var(--shadow)}
    h1{margin:0;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 10px;border-radius:999px;background:#2b1025;border:1px solid rgba(255,255,255,.12)}
    .countDot{width:8px;height:8px;border-radius:50%;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.2)}
    .tabs{position:sticky;top:56px;z-index:5;display:flex;gap:10px;padding:8px var(--pad);background:rgba(57,22,41,.75);border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
    .tabBtn{flex:1;height:40px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#2f1430;color:#f2eaf3;font-weight:800;letter-spacing:.2px}
    .tabBtn.active{background:#3b1840;border-color:rgba(255,255,255,.22)}
    .container{max-width:820px;margin:0 auto;padding:10px var(--pad) calc(40px + env(safe-area-inset-bottom));display:grid;gap:14px}
    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
    h2.sectionTitle{margin:0;padding:12px var(--pad);font-size:14px;color:#f5d9e8;border-bottom:1px solid rgba(255,255,255,.08)}

    /* PLAY */
    .playWrap{display:grid;gap:14px}
    @media (min-width:720px){.playWrap{grid-template-columns:1.1fr .9fr}}
    .stageInner{width:100%;height:min(58vh,420px);height:min(58dvh,420px);border-radius:22px;border:1px dashed rgba(255,255,255,.18);display:grid;place-items:center;position:relative;overflow:hidden;background:linear-gradient(145deg,rgba(255,255,255,.04),rgba(255,255,255,0));cursor:pointer}
    .stageInner:active{filter:brightness(1.03)}
    .placeholder{color:#e7cfe0;font-size:14px;padding:0 10px;text-align:center}
    .big-card{width:92%;height:82%;border-radius:22px;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px;box-shadow:0 15px 40px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.08);transform:scale(.98);transition:transform .25s ease}
    .big-card .text{font-size:clamp(22px,6vw,40px);font-weight:900;line-height:1.05;letter-spacing:.2px;color:#fff;text-shadow:0 4px 18px rgba(0,0,0,.45)}
    .big-card.pulse{animation:pulse .9s ease}
    @keyframes pulse{0%{transform:scale(.98)}40%{transform:scale(1.02)}100%{transform:scale(1)}}

    /* DICE */
    .dicePanel{padding:var(--pad);display:grid;gap:12px}
    .diceArea{display:grid;gap:10px;place-items:center;cursor:pointer}
    .diceArea:active{filter:brightness(1.03)}
    .diceRow{display:flex;gap:14px;justify-content:center;align-items:center;flex-wrap:wrap}
    .die{width:min(34vw,150px);height:min(34vw,150px);border-radius:24px;background:linear-gradient(135deg,#c01757,#7b1f57);display:grid;place-items:center;box-shadow:0 16px 40px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.08);transform:translateZ(0);position:relative}
    /* stronger roll */
    .die.roll{animation:shakeStrong .9s cubic-bezier(.34,1.56,.3,1)}
    @keyframes shakeStrong{
      0%{transform:rotate(0deg) scale(1)}
      15%{transform:rotate(12deg) translate(4px,-4px) scale(1.06)}
      30%{transform:rotate(-10deg) translate(-6px,5px) scale(1.03)}
      45%{transform:rotate(8deg) translate(5px,3px) scale(1.05)}
      60%{transform:rotate(-6deg) translate(-4px,-3px) scale(1.02)}
      80%{transform:rotate(3deg) translate(2px,-2px) scale(1.04)}
      100%{transform:rotate(0deg) scale(1)}
    }
    .numDisplay{font-weight:900;font-size:clamp(36px,10vw,64px);color:#fff;text-shadow:0 8px 22px rgba(0,0,0,.45)}
    .lastRoll{font-size:14px;color:#f2eaf3}
    .sum{font-weight:800;padding:6px 10px;background:#2f1430;border:1px solid rgba(255,255,255,.14);border-radius:999px}

    /* CONFIG */
    .cfgWrap{padding:var(--pad);display:grid;gap:14px}
    .grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:460px){.grid2{grid-template-columns:1fr}}
    label{font-size:12px;color:#f5d9e8}
    select{height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:#2f1430;color:#fff;padding:0 12px;font-size:16px}
    .creator{padding:var(--pad);display:grid;gap:var(--gap)}

    /* Buttons (spacing kept) */
    .btn{height:44px;border-radius:12px;border:0;font-weight:800;color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.25);background:linear-gradient(180deg,var(--accent6),#085e69);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btnRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
    .btnRow + .btnRow{margin-top:10px}
    @media (max-width:460px){.btnRow{grid-template-columns:1fr}}

    input[type="color"]{width:100%;height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:transparent}
    input[type="text"]{height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#2f1430;color:#fff;padding:0 14px;outline:none;font-size:16px}
    .gridCards{padding:var(--pad);display:grid;grid-template-columns:repeat(2,1fr);gap:var(--gap)}
    @media (min-width:520px){.gridCards{grid-template-columns:repeat(3,1fr)}}
    @media (min-width:760px){.gridCards{grid-template-columns:repeat(4,1fr)}}
    .card{position:relative;border-radius:16px;height:120px;display:flex;align-items:center;justify-content:center;text-align:center;padding:12px;box-shadow:0 10px 20px rgba(0,0,0,.25),inset 0 0 0 1px rgba(255,255,255,.06);user-select:none;cursor:pointer}
    .card .text{color:#fff;font-weight:800;line-height:1.05;text-shadow:0 1px 2px rgba(0,0,0,.35),0 6px 18px rgba(0,0,0,.35);font-size:clamp(12px,3.5vw,16px);word-break:break-word}
    .del{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:50%;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.12);color:#fff;display:grid;place-items:center;cursor:pointer;backdrop-filter:blur(4px)}

    /* Modal editor */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:30}
    .modalCard{width:min(92vw,520px);background:#3b1840;border:1px solid rgba(255,255,255,.18);border-radius:16px;box-shadow:var(--shadow)}
    .modalHeader{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12)}
    .modalBody{padding:14px;display:grid;gap:10px}
    .closeX{background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer}
    .modalRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:480px){.modalRow{grid-template-columns:1fr}}
    .modalActions{display:flex;gap:10px;justify-content:flex-end;padding:0 14px 14px}
    .btnDanger{background:linear-gradient(180deg,var(--accent5),#8d0000)}

    #iosBanner{position:fixed;left:12px;right:12px;bottom:calc(30px + env(safe-area-inset-bottom));background:#2f1430;border:1px solid rgba(255,255,255,.12);color:#e8edf7;border-radius:14px;padding:12px 14px;z-index:20;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;align-items:center;gap:10px;font-size:14px}
    #iosBanner .close{margin-left:auto;background:transparent;border:0;color:#fff;font-size:18px;line-height:1;cursor:pointer}
    #iosBanner small{display:block;color:#f0d7e3;margin-top:4px}
    :focus-visible{outline:2px solid rgba(255,255,255,.85);outline-offset:2px;border-radius:12px}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>Ludo Ju&amp;Heb — Play</h1>
    </div>
    <div class="pill" aria-live="polite"><span class="countDot"></span><span id="count">0 cartas</span></div>
  </header>

  <div class="tabs" role="tablist">
    <button id="tabPlay" class="tabBtn active" role="tab" aria-selected="true" aria-controls="viewPlay">PLAY</button>
    <button id="tabCfg" class="tabBtn" role="tab" aria-selected="false" aria-controls="viewCfg">Configurações</button>
  </div>

  <div id="iosBanner">
    <div>📲 Instale este app</div>
    <button class="close" aria-label="Fechar">×</button>
    <small>No iPhone: toque <strong>Compartilhar</strong> → <strong>Adicionar à Tela de Início</strong>.</small>
  </div>

  <main class="container">
    <!-- PLAY -->
    <section id="viewPlay" class="playWrap" role="tabpanel" aria-labelledby="tabPlay">
      <section class="panel" aria-labelledby="stageTitle">
        <h2 id="stageTitle" class="sectionTitle">Sorteio de Cartas</h2>
        <div class="stageInner" id="stageInner" role="button" tabindex="0" aria-label="Área de sorteio (toque para sortear)">
          <div class="placeholder" id="placeholder">Toque aqui para <strong>Sortear</strong> uma carta 🎲</div>
        </div>
      </section>

      <section class="panel dicePanel" aria-labelledby="diceTitle">
        <h2 id="diceTitle" class="sectionTitle">Dados</h2>
        <div class="diceArea" id="diceArea" role="button" tabindex="0" aria-label="Área de dados (toque para rolar)">
          <div class="diceRow" id="diceRow"></div>
          <div class="lastRoll" id="lastRoll">Toque para <strong>Rolar</strong>.</div>
        </div>
      </section>
    </section>

    <!-- CONFIG -->
    <section id="viewCfg" class="hidden" role="tabpanel" aria-labelledby="tabCfg">
      <div class="panel cfgWrap">
        <h2 class="sectionTitle">Regras dos Dados</h2>
        <div class="grid2">
          <div><label for="diceCount">Quantidade de dados</label><select id="diceCount"><option value="1">1 dado</option><option value="2">2 dados</option></select></div>
          <div><label for="dieSides">Lados por dado</label><select id="dieSides"><option value="4">D4</option><option value="6" selected>D6</option><option value="8">D8</option><option value="10">D10</option><option value="12">D12</option><option value="20">D20</option></select></div>
        </div>
        <div class="grid2">
          <div class="switch" style="grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#2f1430">
            <span>Som</span><input id="soundToggle" type="checkbox" checked>
          </div>
        </div>
      </div>

      <section class="panel creator" aria-labelledby="creatorTitle">
        <h2 id="creatorTitle" class="sectionTitle">Criar/Importar Cartas</h2>
        <form id="cardForm" autocomplete="off">
          <div class="grid2">
            <div><label for="color">Cor da carta</label><input id="color" type="color" value="#ff0a54" aria-label="Escolher cor da carta" /></div>
            <div><label for="text">Texto (aparece em branco no centro)</label><input id="text" type="text" placeholder="Ex.: Hoje é o seu dia!" maxlength="120" /></div>
          </div>
          <div class="btnRow">
            <button type="submit" class="btn">Adicionar carta</button>
            <button type="button" id="sampleBtn" class="btn">Exemplos</button>
          </div>
          <div class="btnRow">
            <button type="button" id="exportBtn" class="btn">Exportar baralho</button>
            <button type="button" id="importBtn" class="btn">Importar baralho</button>
          </div>
        </form>
      </section>

      <section class="panel" aria-labelledby="listTitle">
        <h2 id="listTitle" class="sectionTitle">Suas cartas (toque para editar)</h2>
        <div id="grid" class="gridCards" aria-live="polite" aria-busy="false"></div>
      </section>
    </section>
  </main>

  <script>
    // --- PWA ---
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }
    const isIos = () => /iphone|ipad|ipod/i.test(window.navigator.userAgent);
    const isInStandalone = () => window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const iosBanner = document.getElementById('iosBanner'); const iosClose = iosBanner.querySelector('.close'); const IOS_BANNER_KEY = 'iosBannerDismissed_v7';
    function maybeShowIosBanner(){ if (isIos() && !isInStandalone() && !localStorage.getItem(IOS_BANNER_KEY)) iosBanner.style.display = 'flex'; }
    iosClose.addEventListener('click', ()=>{ iosBanner.style.display='none'; localStorage.setItem(IOS_BANNER_KEY,'1'); });
    window.addEventListener('load', maybeShowIosBanner);

    // --- State ---
    const STORAGE_DECK = "ludojuheb_deck_v4";
    const STORAGE_CFG  = "ludojuheb_cfg_v4";
    let cards = [];
    let cfg = { diceCount:1, dieSides:6, sound:true };

    const $ = (sel, root=document) => root.querySelector(sel);

    function saveDeck(){ localStorage.setItem(STORAGE_DECK, JSON.stringify(cards)); updateCount(); }
    function loadDeck(){ try{ cards = JSON.parse(localStorage.getItem(STORAGE_DECK)) || []; }catch{ cards=[]; } updateCount(); }
    function saveCfg(){ localStorage.setItem(STORAGE_CFG, JSON.stringify(cfg)); }
    function loadCfg(){ try{ Object.assign(cfg, JSON.parse(localStorage.getItem(STORAGE_CFG))||{}); }catch{} }

    function updateCount(){
      const c = cards.length;
      document.getElementById('count').textContent = c + (c === 1 ? ' carta' : ' cartas');
      document.querySelector('.countDot').style.background = c ? '#22c55e' : '#999';
      document.getElementById('grid').setAttribute('aria-busy','false');
    }
    function escapeHTML(str){ return String(str).replace(/[&<>'"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;' }[c])); }
    function cardEl(card){
      const el = document.createElement('div'); el.className='card'; el.style.background = card.color;
      el.innerHTML = `<div class="del" role="button" title="Apagar" aria-label="Apagar">×</div><div class="text">${escapeHTML(card.text||'')}</div>`;
      el.querySelector('.del').addEventListener('click', (ev)=>{ ev.stopPropagation(); cards = cards.filter(c=>c.id!==card.id); saveDeck(); renderGrid(); });
      el.addEventListener('click', ()=> openEditor(card.id));
      return el;
    }
    function renderGrid(){
      const grid = document.getElementById('grid'); grid.innerHTML = '';
      if(!cards.length){ grid.innerHTML = '<div style="grid-column:1/-1;color:#f0d7e3;padding:6px 2px">Nenhuma carta. Importe ou crie acima ✨</div>'; return; }
      const frag = document.createDocumentFragment(); cards.forEach(c => frag.appendChild(cardEl(c))); grid.appendChild(frag);
    }
    function renderStagePlaceholder(){ document.getElementById('stageInner').innerHTML = '<div class="placeholder">Toque aqui para <strong>Sortear</strong> uma carta 🎲</div>'; }

    function showBigCard(card){
      const stage = document.getElementById('stageInner'); stage.innerHTML = '';
      const big = document.createElement('div'); big.className = 'big-card pulse'; big.style.background = card.color;
      big.innerHTML = `<div class="text">${escapeHTML(card.text||'')}</div>`; stage.appendChild(big);
      sfx('card');
      setTimeout(()=> big.classList.remove('pulse'), 900);
    }

    function addCard(text, color){
      const t = (text||'').trim(); if(!t){ toast('Digite um texto para a carta.'); return; }
      const id = Date.now().toString(36)+Math.random().toString(36).slice(2,7);
      cards.push({id,text:t,color: color || '#ff0a54'}); saveDeck(); renderGrid();
    }
    function sampleCards(){[{text:'Hoje é o seu dia!', color:'#ff0a54'},{text:'Você vai arrasar!', color:'#017b3e'},{text:'Respira. Vai dar certo.', color:'#613f75'},{text:'Liga o modo foco 🔥', color:'#e85d04'},{text:'Beba água agora!', color:'#087e8b'}].forEach(s => addCard(s.text, s.color));}

    function exportDeck(){
      if(!cards.length){ toast('Nada para exportar.'); return; }
      const data = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(cards, null, 2));
      const a = document.createElement('a'); a.href = data; a.download = 'cartas.json'; document.body.appendChild(a); a.click(); a.remove();
    }
    function importDeck(){
      const input = document.createElement('input'); input.type='file'; input.accept='application/json';
      input.onchange = () => {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const imported = JSON.parse(e.target.result);
            if(!Array.isArray(imported)) throw new Error('formato inválido');
            cards = imported.map(it => ({ id:(it.id || (Date.now()+Math.random()).toString(36)), text:String(it.text||'').slice(0,120), color:/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(it.color||'')?it.color:pickColor() }));
            saveDeck(); renderGrid(); renderStagePlaceholder(); toast('Baralho importado!');
          }catch{ toast('Falha ao importar JSON.'); }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    const palette = ['#017b3e','#ff0a54','#613f75','#e85d04','#d00000','#087e8b'];
    function pickColor(){ return palette[Math.floor(Math.random()*palette.length)]; }

    // --- Dice (numeric) ---
    function renderDice(){
      const row = document.getElementById('diceRow'); row.innerHTML='';
      const count = cfg.diceCount|0; const sides = cfg.dieSides|0;
      for(let i=0;i<count;i++){
        const d = document.createElement('div'); d.className='die';
        const n = document.createElement('div'); n.className='numDisplay'; n.textContent = sides;
        d.appendChild(n); row.appendChild(d);
      }
    }
    function rollDice(){
      ensureAC();
      const count = cfg.diceCount|0; const sides = cfg.dieSides|0;
      const dice = Array.from(document.querySelectorAll('.die'));
      let sum = 0; let values=[];
      dice.forEach((d,idx)=>{ d.classList.remove('roll'); void d.offsetWidth; d.style.animationDelay = (idx*0.05)+'s'; d.classList.add('roll'); });
      // fun sfx: três estalos curtos + sweep final
      sfx('diceStart'); setTimeout(()=>sfx('diceMid'),120); setTimeout(()=>sfx('diceEnd'),260);
      for(let i=0;i<count;i++){
        const v = 1 + Math.floor(Math.random()*sides); values.push(v); sum += v;
        dice[i].querySelector('.numDisplay').textContent = v;
      }
      document.getElementById('lastRoll').innerHTML = 'Resultado: <strong>'+values.join(' , ')+'</strong> ' + (count>1?'<span class="sum">Soma: '+sum+'</span>':'');
    }

    // --- WebAudio SFX ---
    let AC=null;
    function ensureAC(){ if(!AC){ try{ AC=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } if(AC && AC.state==='suspended'){ AC.resume(); } }
    function blip(freqA,freqB,duration){
      const now = AC.currentTime;
      const o = AC.createOscillator(); const g = AC.createGain();
      o.type = 'triangle'; o.frequency.setValueAtTime(freqA, now); o.frequency.exponentialRampToValueAtTime(freqB, now+duration*0.9);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.35, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+duration);
      o.connect(g).connect(AC.destination); o.start(now); o.stop(now+duration+0.02);
    }
    function sfx(kind){
      if(!cfg.sound) return;
      ensureAC(); if(!AC) return;
      if(kind==='card'){ blip(660,440,0.22); }
      else if(kind==='diceStart'){ blip(220,380,0.12); }
      else if(kind==='diceMid'){ blip(260,480,0.12); }
      else if(kind==='diceEnd'){ blip(300,900,0.22); }
      else { blip(600,420,0.18); }
    }

    // --- Modal editor ---
    function openEditor(id){
      const card = cards.find(c=>c.id===id); if(!card) return;
      const modal = document.createElement('div'); modal.className='modal'; modal.innerHTML = `
        <div class="modalCard" role="dialog" aria-modal="true">
          <div class="modalHeader"><strong>Editar carta</strong><button class="closeX" aria-label="Fechar">×</button></div>
          <div class="modalBody">
            <div class="modalRow">
              <div><label for="editColor">Cor</label><input id="editColor" type="color" value="${card.color}"></div>
              <div><label for="editText">Texto</label><input id="editText" type="text" value="${escapeHTML(card.text)}" maxlength="120"></div>
            </div>
          </div>
          <div class="modalActions">
            <button class="btn btnDanger" id="delBtn">Apagar</button>
            <button class="btn" id="saveBtn">Salvar</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      const close = ()=> modal.remove();
      modal.querySelector('.closeX').addEventListener('click', close);
      modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
      modal.querySelector('#saveBtn').addEventListener('click', ()=>{
        const newText = modal.querySelector('#editText').value.trim().slice(0,120);
        const newColor = modal.querySelector('#editColor').value;
        card.text = newText || card.text; card.color = newColor || card.color; saveDeck(); renderGrid(); close();
      });
      modal.querySelector('#delBtn').addEventListener('click', ()=>{
        if(confirm('Apagar esta carta?')){ cards = cards.filter(c=>c.id!==id); saveDeck(); renderGrid(); close(); }
      });
    }

    // --- Tabs ---
    const tabPlay = document.getElementById('tabPlay'), tabCfg = document.getElementById('tabCfg'), viewPlay = document.getElementById('viewPlay'), viewCfg = document.getElementById('viewCfg');
    function switchTab(tab){ if(tab==='play'){ tabPlay.classList.add('active'); tabPlay.setAttribute('aria-selected','true'); tabCfg.classList.remove('active'); tabCfg.setAttribute('aria-selected','false'); viewPlay.classList.remove('hidden'); viewCfg.classList.add('hidden'); } else { tabCfg.classList.add('active'); tabCfg.setAttribute('aria-selected','true'); tabPlay.classList.remove('active'); tabPlay.setAttribute('aria-selected','false'); viewCfg.classList.remove('hidden'); viewPlay.classList.add('hidden'); } window.scrollTo({top:0,behavior:'smooth'}); }
    tabPlay.addEventListener('click', ()=> switchTab('play'));
    tabCfg.addEventListener('click', ()=> switchTab('cfg'));

    // --- Interactions (click-to-act) ---
    document.getElementById('stageInner').addEventListener('click', ()=>{
      ensureAC();
      if(cards.length===0){ toast('Adicione/importe cartas em Configurações.'); return; }
      const cycles = Math.max(18, Math.min(60, 10 + cards.length * 4));
      let i = 0, lastIdx = -1;
      const stage = document.getElementById('stageInner'); stage.innerHTML = '';
      const temp = document.createElement('div'); temp.className='big-card'; temp.style.background='#7b1f57'; temp.innerHTML = '<div class="text" style="opacity:.8">Embaralhando…</div>'; stage.appendChild(temp);
      const interval = setInterval(()=>{
        let idx; do{ idx = Math.floor(Math.random() * cards.length); } while(cards.length>1 && idx === lastIdx);
        lastIdx = idx; const c = cards[idx];
        temp.style.background = c.color; temp.querySelector('.text').textContent = c.text;
        i++; temp.style.transform = 'scale('+(0.98 + Math.random()*0.04)+')';
        if(i >= cycles){ clearInterval(interval); setTimeout(()=> showBigCard(cards[Math.floor(Math.random()*cards.length)]), 140); }
      }, 90);
    });
    document.getElementById('diceArea').addEventListener('click', ()=>{ rollDice(); });
    document.getElementById('stageInner').addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); document.getElementById('stageInner').click(); }});
    document.getElementById('diceArea').addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); document.getElementById('diceArea').click(); }});

    // --- Config bindings ---
    function applyCfgToUI(){ document.getElementById('diceCount').value = String(cfg.diceCount); document.getElementById('dieSides').value = String(cfg.dieSides); document.getElementById('soundToggle').checked = !!cfg.sound; renderDice(); }
    document.getElementById('diceCount').addEventListener('change', (e)=>{ cfg.diceCount = parseInt(e.target.value,10)||1; saveCfg(); renderDice(); });
    document.getElementById('dieSides').addEventListener('change', (e)=>{ cfg.dieSides = parseInt(e.target.value,10)||6; saveCfg(); renderDice(); });
    document.getElementById('soundToggle').addEventListener('change', (e)=>{ cfg.sound = e.target.checked; saveCfg(); });

    // Toast
    function toast(msg){
      const t = document.createElement('div'); t.textContent = msg;
      t.style.cssText = 'position: fixed; left: 50%; transform: translateX(-50%); bottom: calc(env(safe-area-inset-bottom) + 18px); background: rgba(0,0,0,.78); color: #fff; padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); z-index: 9999; font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,.35)';
      document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .4s'; }, 1800); setTimeout(()=> t.remove(), 2300);
    }

    document.addEventListener('DOMContentLoaded', ()=>{ loadCfg(); loadDeck(); renderGrid(); if(!cards.length) renderStagePlaceholder(); applyCfgToUI(); });
  </script>
</body>
</html>
